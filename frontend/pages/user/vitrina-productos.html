<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vitrina de Productos - Nenis y Bros</title>
    <link rel="stylesheet" href="../../assets/css/style.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f5f6fa; }
        .admin-container { display: flex; min-height: 100vh; }
        .admin-sidebar { width: 260px; background: #2c3e50; color: white; position: fixed; height: 100vh; overflow-y: auto; }
        .admin-logo { padding: 1.5rem; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .admin-logo h1 { font-size: 1.5rem; margin: 0; }
        .admin-logo span { font-size: 0.85rem; opacity: 0.8; display: block; margin-top: 0.25rem; }
        .admin-menu { list-style: none; padding: 1rem 0; }
        .admin-menu a { display: block; padding: 0.875rem 1.5rem; color: rgba(255,255,255,0.8); text-decoration: none; transition: all 0.3s; }
        .admin-menu a:hover, .admin-menu a.active { background: rgba(255,255,255,0.1); color: white; }
        .admin-main { margin-left: 260px; flex: 1; padding: 2rem; }
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid #e5e7eb; }
        .admin-header h2 { font-size: 1.75rem; color: #2c3e50; }
        .btn-logout { padding: 0.5rem 1rem; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; }

        /* Filtros */
        .filters-section { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        .filters-title { font-size: 1.1rem; margin-bottom: 1rem; color: #2c3e50; }
        .filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
        .filter-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .filter-group label { font-weight: 600; color: #7f8c8d; font-size: 0.9rem; }
        .filter-group input, .filter-group select { padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.9rem; }
        .filter-group input:focus, .filter-group select:focus { outline: none; border-color: #667eea; }
        .filter-actions { display: flex; gap: 1rem; justify-content: flex-end; }
        .btn-filter { padding: 0.75rem 1.5rem; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .btn-filter:hover { background: #2980b9; }
        .btn-reset { padding: 0.75rem 1.5rem; background: #95a5a6; color: white; border: none; border-radius: 6px; cursor: pointer; }

        /* Categor√≠as */
        .categories-carousel { margin-bottom: 2rem; overflow-x: auto; padding: 1rem 0; }
        .categories-list { display: flex; gap: 1rem; }
        .category-chip { flex-shrink: 0; padding: 0.75rem 1.5rem; background: white; border: 2px solid #e5e7eb; border-radius: 20px; cursor: pointer; transition: all 0.3s; font-weight: 600; white-space: nowrap; }
        .category-chip:hover { border-color: #667eea; }
        .category-chip.active { background: #667eea; color: white; border-color: #667eea; }

        /* Productos Grid */
        .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .results-count { font-size: 1rem; color: #7f8c8d; }
        .results-count strong { color: #667eea; }
        .sort-select { padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 6px; background: white; }
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .product-card { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.3s, box-shadow 0.3s; cursor: pointer; position: relative; }
        .product-card:hover { transform: translateY(-4px); box-shadow: 0 8px 16px rgba(0,0,0,0.15); }
        .product-image { width: 100%; height: 200px; object-fit: cover; background: #e5e7eb; }
        .product-badge { position: absolute; top: 10px; left: 10px; background: #667eea; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600; }
        .product-badge.destacado { background: linear-gradient(135deg, #f093fb, #f5576c); }
        .product-content { padding: 1rem; }
        .product-category { color: #667eea; font-size: 0.85rem; font-weight: 600; margin-bottom: 0.5rem; }
        .product-title { font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem; color: #2c3e50; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .product-description { color: #7f8c8d; font-size: 0.85rem; margin-bottom: 1rem; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .product-footer { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #e5e7eb; padding-top: 1rem; }
        .product-price { font-size: 1.3rem; font-weight: bold; color: #667eea; }
        .product-price small { font-size: 0.6rem; font-weight: 400; color: #7f8c8d; }
        .product-location { color: #7f8c8d; font-size: 0.8rem; margin-top: 0.5rem; }
        .product-seller { display: flex; align-items: center; gap: 0.5rem; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e5e7eb; }
        .seller-avatar { width: 24px; height: 24px; border-radius: 50%; background: #e5e7eb; }
        .seller-name { font-size: 0.8rem; color: #7f8c8d; }

        /* Paginaci√≥n */
        .pagination { display: flex; justify-content: center; align-items: center; gap: 1rem; margin-top: 2rem; }
        .pagination button { padding: 0.75rem 1.25rem; border: 2px solid #e5e7eb; background: white; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .pagination button:hover:not(:disabled) { border-color: #667eea; color: #667eea; }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Loading & Empty */
        .loading, .empty-state { text-align: center; padding: 4rem 2rem; }
        .spinner { display: inline-block; width: 40px; height: 40px; border: 4px solid #e5e7eb; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .empty-state-icon { font-size: 4rem; margin-bottom: 1rem; }
        .empty-state h3 { margin-bottom: 0.5rem; color: #2c3e50; }
        .empty-state p { color: #7f8c8d; margin-bottom: 1rem; }
    </style>
</head>
<body>
    <div class="admin-container">
        <aside class="admin-sidebar">
            <div class="admin-logo">
                <h1>üöÄ Nenis y Bros</h1>
                <span>Panel Emprendedor</span>
            </div>
            <ul class="admin-menu">
                <li><a href="./dashboard.html" data-page="dashboard">üìä Dashboard</a></li>
                <li><a href="./diagnosticos.html" data-page="diagnosticos">üìã Diagn√≥sticos</a></li>
                <li><a href="./mi-progreso.html" data-page="mi-progreso">üìà Mi Progreso</a></li>
                <li><a href="./perfil-empresarial.html" data-page="perfil">üè¢ Mi Empresa</a></li>
                <li><a href="./mis-logros.html" data-page="logros">üèÜ Mis Logros</a></li>
                <li><a href="./ranking.html" data-page="ranking">ü•á Ranking</a></li>
                <li><a href="./vitrina-productos.html" data-page="vitrina">üõçÔ∏è Vitrina de Productos</a></li>
                <li><a href="./mis-productos.html" data-page="productos">üì¶ Mis Productos</a></li>
                <li><a href="./chat.html" data-page="chat">üí¨ Chat</a></li>
                <li><a href="./notificaciones.html" data-page="notificaciones">üîî Notificaciones</a></li>
            </ul>
        </aside>

        <main class="admin-main">
            <div class="admin-header">
                <h2>üõçÔ∏è Vitrina de Productos</h2>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <a href="./publicar-producto.html" class="btn-filter">‚ûï Publicar Producto</a>
                    <button class="btn-logout" onclick="logout()">Cerrar Sesi√≥n</button>
                </div>
            </div>

            <!-- Categor√≠as -->
            <div class="categories-carousel">
                <div class="categories-list" id="categoriesList">
                    <div class="category-chip active" data-category="">Todas las categor√≠as</div>
                </div>
            </div>

            <!-- Filtros -->
            <div class="filters-section">
                <div class="filters-title">üîç Filtros de B√∫squeda</div>
                <div class="filters-grid">
                    <div class="filter-group">
                        <label>Buscar</label>
                        <input type="text" id="searchInput" placeholder="Buscar productos...">
                    </div>
                    <div class="filter-group">
                        <label>Tipo de Producto</label>
                        <select id="tipoFilter">
                            <option value="">Todos</option>
                            <option value="producto_fisico">Producto F√≠sico</option>
                            <option value="servicio">Servicio</option>
                            <option value="producto_digital">Producto Digital</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Precio M√≠nimo</label>
                        <input type="number" id="precioMin" placeholder="$ 0" min="0">
                    </div>
                    <div class="filter-group">
                        <label>Precio M√°ximo</label>
                        <input type="number" id="precioMax" placeholder="$ 10,000" min="0">
                    </div>
                </div>
                <div class="filter-actions">
                    <button class="btn-reset" onclick="resetFilters()">Limpiar</button>
                    <button class="btn-filter" onclick="applyFilters()">Buscar</button>
                </div>
            </div>

            <!-- Resultados -->
            <div class="results-header">
                <div class="results-count">Se encontraron <strong id="totalResults">0</strong> productos</div>
                <select class="sort-select" id="sortSelect" onchange="applyFilters()">
                    <option value="recientes">M√°s recientes</option>
                    <option value="precio_asc">Precio: Menor a Mayor</option>
                    <option value="precio_desc">Precio: Mayor a Menor</option>
                </select>
            </div>

            <!-- Grid de Productos -->
            <div id="productsContainer">
                <div class="loading"><div class="spinner"></div><p>Cargando productos...</p></div>
            </div>

            <!-- Paginaci√≥n -->
            <div class="pagination" id="pagination" style="display: none;">
                <button id="prevPage" onclick="changePage(-1)">‚Üê Anterior</button>
                <span id="pageInfo">P√°gina 1 de 1</span>
                <button id="nextPage" onclick="changePage(1)">Siguiente ‚Üí</button>
            </div>
        </main>
    </div>

    <script src="../../assets/js/config.js"></script>
    <script src="../../assets/js/auth.js"></script>
    <script src="../../assets/js/api.js"></script>
    <script>
        if (!checkAuth() || (!isEmprendedor() && !isEmpresario())) window.location.href = ROUTES.login;

        let currentPage = 1;
        let totalPages = 1;
        let currentFilters = {};

        function logout() {
            localStorage.removeItem(AUTH_TOKEN_KEY);
            localStorage.removeItem(AUTH_USER_KEY);
            window.location.href = ROUTES.login;
        }

        function highlightActiveLink() {
            const currentPageName = window.location.pathname.split('/').pop();
            document.querySelectorAll('.admin-menu a').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === './' + currentPageName) link.classList.add('active');
            });
        }

        async function loadCategories() {
            try {
                const response = await apiGet('/productos/categorias');
                if (response.success && response.data) {
                    const container = document.getElementById('categoriesList');
                    response.data.forEach(cat => {
                        const chip = document.createElement('div');
                        chip.className = 'category-chip';
                        chip.dataset.category = cat.id_categoria;
                        chip.textContent = `${cat.nombre} (${cat.total_productos || 0})`;
                        chip.onclick = () => filterByCategory(cat.id_categoria, chip);
                        container.appendChild(chip);
                    });
                }
            } catch (error) {
                console.error('Error cargando categor√≠as:', error);
            }
        }

        function filterByCategory(categoryId, element) {
            document.querySelectorAll('.category-chip').forEach(chip => chip.classList.remove('active'));
            element.classList.add('active');
            currentFilters.categoria = categoryId || '';
            currentPage = 1;
            loadProducts();
        }

        async function loadProducts() {
            const container = document.getElementById('productsContainer');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Cargando productos...</p></div>';

            try {
                const queryParams = new URLSearchParams({
                    pagina: currentPage,
                    por_pagina: 12,
                    orden: document.getElementById('sortSelect').value,
                    ...currentFilters
                });

                const response = await apiGet(`/productos?${queryParams}`);
                if (response.success && response.data) {
                    const { productos, total, total_paginas } = response.data;
                    totalPages = total_paginas;
                    document.getElementById('totalResults').textContent = total;

                    if (productos.length === 0) {
                        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì¶</div><h3>No se encontraron productos</h3><p>Intenta ajustar los filtros de b√∫squeda</p></div>';
                    } else {
                        container.innerHTML = `<div class="products-grid">${productos.map(p => createProductCard(p)).join('')}</div>`;
                        if (total_paginas > 1) {
                            document.getElementById('pagination').style.display = 'flex';
                            document.getElementById('pageInfo').textContent = `P√°gina ${currentPage} de ${total_paginas}`;
                            document.getElementById('prevPage').disabled = currentPage === 1;
                            document.getElementById('nextPage').disabled = currentPage === total_paginas;
                        } else {
                            document.getElementById('pagination').style.display = 'none';
                        }
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ùå</div><h3>Error al cargar productos</h3><p>' + error.message + '</p></div>';
            }
        }

        function createProductCard(p) {
            const imagenUrl = p.imagen_principal || 'https://via.placeholder.com/260x200?text=Sin+Imagen';
            const precio = parseFloat(p.precio).toFixed(2);
            const ubicacion = [p.ubicacion_ciudad, p.ubicacion_estado].filter(Boolean).join(', ') || 'Ubicaci√≥n no especificada';
            return `
                <div class="product-card" onclick="window.location.href='producto-detalle.html?id=${p.id_producto}'">
                    <img src="${imagenUrl}" alt="${p.titulo}" class="product-image" onerror="this.src='https://via.placeholder.com/260x200?text=Sin+Imagen'">
                    ${p.destacado ? '<div class="product-badge destacado">‚≠ê Destacado</div>' : ''}
                    <div class="product-content">
                        <div class="product-category">${p.categoria_nombre}</div>
                        <h3 class="product-title">${p.titulo}</h3>
                        <p class="product-description">${p.descripcion_corta || 'Sin descripci√≥n'}</p>
                        <div class="product-footer">
                            <div class="product-price">$${precio} <small>${p.moneda}</small></div>
                        </div>
                        <div class="product-location">üìç ${ubicacion}</div>
                        <div class="product-seller">
                            <div class="seller-avatar"></div>
                            <div class="seller-name">${p.vendedor_nombre}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function applyFilters() {
            currentFilters = {
                q: document.getElementById('searchInput').value,
                tipo: document.getElementById('tipoFilter').value,
                precio_min: document.getElementById('precioMin').value,
                precio_max: document.getElementById('precioMax').value
            };
            Object.keys(currentFilters).forEach(key => { if (!currentFilters[key]) delete currentFilters[key]; });
            currentPage = 1;
            loadProducts();
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('tipoFilter').value = '';
            document.getElementById('precioMin').value = '';
            document.getElementById('precioMax').value = '';
            document.getElementById('sortSelect').value = 'recientes';
            document.querySelectorAll('.category-chip').forEach(chip => chip.classList.remove('active'));
            document.querySelector('.category-chip[data-category=""]').classList.add('active');
            currentFilters = {};
            currentPage = 1;
            loadProducts();
        }

        function changePage(direction) {
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                loadProducts();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') applyFilters();
        });

        document.addEventListener('DOMContentLoaded', () => {
            highlightActiveLink();
            loadCategories();
            loadProducts();
        });
    </script>
</body>
</html>
