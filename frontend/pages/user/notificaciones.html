<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notificaciones - Nenis y Bros</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f6fa; color: #2c3e50; }
        
        /* Admin Layout */
        .admin-container { display: flex; min-height: 100vh; }
        .admin-sidebar { width: 260px; background: #2c3e50; color: white; position: fixed; height: 100vh; overflow-y: auto; z-index: 1000; }
        .admin-logo { padding: 1.5rem; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .admin-logo h1 { font-size: 1.5rem; margin: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .admin-logo span { font-size: 0.85rem; opacity: 0.8; display: block; margin-top: 0.25rem; }
        .admin-menu { list-style: none; padding: 1rem 0; }
        .admin-menu li { margin: 0; }
        .admin-menu a { display: block; padding: 0.875rem 1.5rem; color: rgba(255,255,255,0.8); text-decoration: none; transition: all 0.3s; border-left: 4px solid transparent; }
        .admin-menu a:hover { background: rgba(255,255,255,0.1); color: white; }
        .admin-menu a.active { background: rgba(255,255,255,0.1); color: white; border-left-color: #667eea; }
        .admin-main { margin-left: 260px; flex: 1; padding: 30px; }

        /* Page Header */
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #e5e7eb; }
        .admin-header h2 { font-size: 2rem; color: #2c3e50; font-weight: 600; }
        .btn-logout { padding: 10px 20px; background: #e74c3c; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.95rem; font-weight: 500; transition: all 0.3s; }
        .btn-logout:hover { background: #c0392b; transform: translateY(-2px); }

        /* Actions Bar */
        .actions-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px; }
        .filter-tabs { display: flex; gap: 10px; flex-wrap: wrap; }
        .filter-tab { padding: 10px 20px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; font-weight: 600; color: #7f8c8d; font-size: 0.9rem; transition: all 0.3s; }
        .filter-tab:hover { border-color: #667eea; color: #667eea; }
        .filter-tab.active { background: #667eea; color: white; border-color: #667eea; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3); }
        .btn-marcar { padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: all 0.3s; }
        .btn-marcar:hover { background: #2980b9; transform: translateY(-2px); }

        /* Notificaciones */
        .notificaciones-container { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; }
        .notificacion { padding: 20px 25px; border-bottom: 1px solid #e5e7eb; display: flex; gap: 15px; cursor: pointer; transition: all 0.3s; position: relative; }
        .notificacion:hover { background: #f8f9fa; }
        .notificacion.no-leida { background: #f0f4ff; border-left: 4px solid #667eea; }
        .notificacion:last-child { border-bottom: none; }
        
        .notif-icon { width: 55px; height: 55px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.75rem; flex-shrink: 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .notif-icon.info { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; }
        .notif-icon.success { background: linear-gradient(135deg, #27ae60 0%, #229954 100%); color: white; }
        .notif-icon.warning { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white; }
        .notif-icon.error { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; }
        
        .notif-content { flex: 1; }
        .notif-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px; gap: 10px; }
        .notif-titulo { font-weight: 600; color: #2c3e50; font-size: 1.05rem; display: flex; align-items: center; gap: 8px; }
        .notif-tiempo { font-size: 0.85rem; color: #7f8c8d; white-space: nowrap; }
        .notif-mensaje { color: #7f8c8d; font-size: 0.95rem; line-height: 1.6; margin-bottom: 12px; }
        .notif-acciones { display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap; }
        .notif-btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 600; transition: all 0.3s; }
        .notif-btn-primary { background: #667eea; color: white; }
        .notif-btn-primary:hover { background: #5568d3; transform: translateY(-1px); }
        .notif-btn-secondary { background: #e5e7eb; color: #7f8c8d; }
        .notif-btn-secondary:hover { background: #d1d5db; }
        .badge-no-leida { width: 10px; height: 10px; border-radius: 50%; background: #667eea; display: inline-block; animation: pulse 2s infinite; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Empty State */
        .empty-state { text-align: center; padding: 80px 30px; }
        .empty-state-icon { font-size: 5rem; margin-bottom: 20px; opacity: 0.5; }
        .empty-state h3 { margin-bottom: 10px; color: #2c3e50; font-size: 1.5rem; }
        .empty-state p { color: #7f8c8d; font-size: 1rem; line-height: 1.5; }

        /* Loading State */
        .loading-state { text-align: center; padding: 60px 20px; }
        .spinner { width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-state p { color: #7f8c8d; font-size: 1rem; }

        /* Responsive */
        @media (max-width: 768px) {
            .admin-sidebar { width: 200px; }
            .admin-main { margin-left: 200px; padding: 20px; }
            .admin-header { flex-direction: column; align-items: flex-start; gap: 15px; }
            .admin-header h2 { font-size: 1.5rem; }
            .actions-bar { flex-direction: column; align-items: stretch; }
            .filter-tabs { width: 100%; }
            .filter-tab { flex: 1; text-align: center; padding: 8px 12px; font-size: 0.85rem; }
            .notificacion { padding: 15px; flex-direction: column; gap: 12px; }
            .notif-icon { width: 45px; height: 45px; font-size: 1.5rem; }
            .notif-header { flex-direction: column; gap: 5px; }
            .notif-acciones { width: 100%; }
            .notif-btn { flex: 1; }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <aside class="admin-sidebar">
            <div class="admin-logo">
                <h1>üöÄ Nenis y Bros</h1>
                <span>Panel Emprendedor</span>
            </div>
            <ul class="admin-menu">
                <li><a href="./dashboard.html" data-page="dashboard">üìä Dashboard</a></li>
                <li><a href="./diagnosticos.html" data-page="diagnosticos">üìã Diagn√≥sticos</a></li>
                <li><a href="./mi-progreso.html" data-page="mi-progreso">üìà Mi Progreso</a></li>
                <li><a href="./perfil-empresarial.html" data-page="perfil">üè¢ Mi Empresa</a></li>
                <li><a href="./mis-logros.html" data-page="logros">üèÜ Mis Logros</a></li>
                <li><a href="./ranking.html" data-page="ranking">ü•á Ranking</a></li>
                <li><a href="./vitrina-productos.html" data-page="vitrina">üõçÔ∏è Vitrina de Productos</a></li>
                <li><a href="./mis-productos.html" data-page="productos">üì¶ Mis Productos</a></li>
                <li><a href="./chat.html" data-page="chat">üí¨ Chat</a></li>
                <li><a href="./notificaciones.html" data-page="notificaciones">üîî Notificaciones</a></li>
            </ul>
        </aside>

        <main class="admin-main">
            <div class="admin-header">
                <h2>üîî Notificaciones</h2>
                <button class="btn-logout" onclick="logout()">Cerrar Sesi√≥n</button>
            </div>

            <!-- Actions Bar -->
            <div class="actions-bar">
                <div class="filter-tabs">
                    <button class="filter-tab active" onclick="filtrarNotificaciones('todas')">Todas (<span id="countTodas">0</span>)</button>
                    <button class="filter-tab" onclick="filtrarNotificaciones('no_leidas')">No Le√≠das (<span id="countNoLeidas">0</span>)</button>
                    <button class="filter-tab" onclick="filtrarNotificaciones('leidas')">Le√≠das</button>
                </div>
                <button class="btn-marcar" onclick="marcarTodasLeidas()">Marcar todas como le√≠das</button>
            </div>

            <!-- Notificaciones -->
            <div class="notificaciones-container" id="notificacionesContainer">
                <div class="empty-state">
                    <div class="empty-state-icon">üì≠</div>
                    <h3>No tienes notificaciones</h3>
                    <p>Aqu√≠ aparecer√°n tus notificaciones cuando tengas nuevas actualizaciones</p>
                </div>
            </div>
        </main>
    </div>

    <script src="../../assets/js/config.js"></script>
    <script src="../../assets/js/auth.js"></script>
    <script src="../../assets/js/api.js"></script>
    <script>
        if (!checkAuth() || (!isEmprendedor() && !isEmpresario())) window.location.href = ROUTES.login;

        let todasNotificaciones = [];
        let filtroActual = 'todas';

        function logout() {
            localStorage.removeItem(AUTH_TOKEN_KEY);
            localStorage.removeItem(AUTH_USER_KEY);
            window.location.href = ROUTES.login;
        }

        function highlightActiveLink() {
            const currentPage = window.location.pathname.split('/').pop();
            document.querySelectorAll('.admin-menu a').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === './' + currentPage) link.classList.add('active');
            });
        }

        async function cargarNotificaciones() {
            try {
                const response = await apiGet('/gamificacion/notificaciones');
                if (response.success && response.data) {
                    todasNotificaciones = response.data.notificaciones || [];
                    actualizarContadores();
                    renderNotificaciones();
                }
            } catch (error) {
                console.error('Error cargando notificaciones:', error);
                // Mostrar notificaciones de ejemplo
                todasNotificaciones = [
                    {
                        id_notificacion: 1,
                        tipo: 'logro',
                        titulo: 'üèÜ Nuevo logro desbloqueado',
                        mensaje: 'Has completado el curso "Marketing Digital B√°sico" y ganado 50 puntos',
                        leida: 0,
                        fecha_creacion: '2025-11-22 10:30:00'
                    },
                    {
                        id_notificacion: 2,
                        tipo: 'sistema',
                        titulo: 'üìä Diagn√≥stico completado',
                        mensaje: 'Tu diagn√≥stico empresarial ha sido procesado. Revisa tus resultados',
                        leida: 0,
                        fecha_creacion: '2025-11-21 15:20:00'
                    },
                    {
                        id_notificacion: 3,
                        tipo: 'producto',
                        titulo: 'üõçÔ∏è Nuevo inter√©s en tu producto',
                        mensaje: 'Alguien ha mostrado inter√©s en "Consultor√≠a Empresarial"',
                        leida: 1,
                        fecha_creacion: '2025-11-20 09:15:00'
                    }
                ];
                actualizarContadores();
                renderNotificaciones();
            }
        }

        function actualizarContadores() {
            const noLeidas = todasNotificaciones.filter(n => n.leida == 0).length;
            document.getElementById('countTodas').textContent = todasNotificaciones.length;
            document.getElementById('countNoLeidas').textContent = noLeidas;
        }

        function filtrarNotificaciones(tipo) {
            filtroActual = tipo;
            document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
            event.target.closest('.filter-tab').classList.add('active');
            renderNotificaciones();
        }

        function renderNotificaciones() {
            let notifFiltradas = todasNotificaciones;
            if (filtroActual === 'no_leidas') {
                notifFiltradas = todasNotificaciones.filter(n => n.leida == 0);
            } else if (filtroActual === 'leidas') {
                notifFiltradas = todasNotificaciones.filter(n => n.leida == 1);
            }

            const container = document.getElementById('notificacionesContainer');
            if (notifFiltradas.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><h3>No hay notificaciones</h3><p>No tienes notificaciones en esta categor√≠a</p></div>';
                return;
            }

            container.innerHTML = notifFiltradas.map(notif => {
                const tipoIcon = getTipoIcon(notif.tipo);
                const tiempoRelativo = calcularTiempoRelativo(notif.fecha_creacion);
                return `
                    <div class="notificacion ${notif.leida == 0 ? 'no-leida' : ''}" onclick="marcarLeida(${notif.id_notificacion})">
                        <div class="notif-icon ${tipoIcon.clase}">${tipoIcon.icono}</div>
                        <div class="notif-content">
                            <div class="notif-header">
                                <div style="display: flex; align-items: center;">
                                    <span class="notif-titulo">${notif.titulo}</span>
                                    ${notif.leida == 0 ? '<span class="badge-no-leida"></span>' : ''}
                                </div>
                                <span class="notif-tiempo">${tiempoRelativo}</span>
                            </div>
                            <div class="notif-mensaje">${notif.mensaje}</div>
                            ${notif.tipo === 'producto' ? `
                                <div class="notif-acciones">
                                    <button class="notif-btn notif-btn-primary" onclick="event.stopPropagation(); window.location.href='mis-productos.html'">Ver Producto</button>
                                    <button class="notif-btn notif-btn-secondary" onclick="event.stopPropagation();">Descartar</button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getTipoIcon(tipo) {
            const iconos = {
                logro: { icono: 'üèÜ', clase: 'success' },
                sistema: { icono: '‚ÑπÔ∏è', clase: 'info' },
                producto: { icono: 'üõçÔ∏è', clase: 'warning' },
                curso: { icono: 'üìö', clase: 'info' },
                default: { icono: 'üîî', clase: 'info' }
            };
            return iconos[tipo] || iconos.default;
        }

        function calcularTiempoRelativo(fecha) {
            const ahora = new Date();
            const entonces = new Date(fecha);
            const diff = Math.floor((ahora - entonces) / 1000);
            
            if (diff < 60) return 'Hace un momento';
            if (diff < 3600) return `Hace ${Math.floor(diff / 60)} min`;
            if (diff < 86400) return `Hace ${Math.floor(diff / 3600)} h`;
            return `Hace ${Math.floor(diff / 86400)} d√≠as`;
        }

        async function marcarLeida(id) {
            try {
                await apiPut(`/gamificacion/notificaciones/${id}/leer`);
                const notif = todasNotificaciones.find(n => n.id_notificacion == id);
                if (notif) notif.leida = 1;
                actualizarContadores();
                renderNotificaciones();
            } catch (error) {
                console.error('Error marcando notificaci√≥n:', error);
            }
        }

        async function marcarTodasLeidas() {
            try {
                await apiPut('/gamificacion/notificaciones/leer-todas');
                todasNotificaciones.forEach(n => n.leida = 1);
                actualizarContadores();
                renderNotificaciones();
            } catch (error) {
                console.error('Error marcando todas:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            highlightActiveLink();
            cargarNotificaciones();
        });
    </script>
</body>
</html>
